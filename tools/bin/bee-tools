#!/usr/bin/env -S deno run -q -A --unstable

'use strict';

import * as path from 'https://deno.land/std@0.202.0/path/mod.ts';
import { parseCommand, runCommand } from '../lib/cli.js';

const PROGNAME = path.basename(Deno.mainModule);
const DIRNAME = path.dirname(path.fromFileUrl(import.meta.url));

const DOC = `
Tools for developers in the BEE project.

Usage:
  ${PROGNAME} analysis <args>...
  ${PROGNAME} codegen <args>...
  ${PROGNAME} deepmerge <args>...
  ${PROGNAME} dom-scraper <args>...
  ${PROGNAME} lexgen <args>...
  ${PROGNAME} layout-builder <args>...
  ${PROGNAME} text-to-dot-matrix <args>...
  ${PROGNAME} top-sites <args>...
  ${PROGNAME} update-file <args>...
  ${PROGNAME} webui <args>...
  ${PROGNAME} help <cmd>
  ${PROGNAME} -h | --help
`.trim();

const { cmds, args, } = await parseCommand({
  doc: DOC,
  init: {
    optionsFirst: true,
  },
});

Deno.exit(await run(cmds, args));

async function run(cmds, args, options) {
  const showHelp = cmds[0] === 'help';
  const cmd = showHelp ? args.cmd : cmds[0];
  try {
    if (showHelp) {
      Deno.exit(await runCommand([`${PROGNAME}-${cmd}`, '--help']));
    } else {
      Deno.exit(await runCommand([`${PROGNAME}-${cmd}`, ...Deno.args.filter((v) => v !== cmd)]));
    }
  } catch (err) {
    if (err instanceof Deno.errors.NotFound) {
      console.error(`'${cmd}' is not a ${PROGNAME} command.  See '${PROGNAME} --help'.`);
    } else {
      console.error(err.message);
    }
    Deno.exit(2);
  }
}
