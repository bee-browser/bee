#!/usr/bin/env -S deno run -q -A --unstable

'use strict';

import * as path from 'https://deno.land/std@0.184.0/path/mod.ts';
import { parseCommand, runCommand } from '../lib/cli.js';

const PROGNAME = path.basename(Deno.mainModule);
const DIRNAME = path.dirname(path.fromFileUrl(import.meta.url));

const DOC = `
Web UI for testing.

Usage:
  ${PROGNAME} serve <args>...
  ${PROGNAME} stop <args>...
  ${PROGNAME} check <args>...
  ${PROGNAME} -h | --help
`.trim();

const { cmds, args, } = await parseCommand({
  doc: DOC,
  init: { optionsFirst: true },
});

Deno.exit(await run(cmds, args));

async function run(cmds, args, options) {
  const showHelp = cmds[0] === 'help';
  const cmd = showHelp ? args.cmd : cmds[0];
  try {
    if (showHelp) {
      Deno.exit(await runCommand([`${PROGNAME}-${cmd}`, '--help']));
    } else {
      Deno.exit(await runCommand([`${PROGNAME}-${cmd}`, ...Deno.args.filter((v) => v !== cmd)]));
    }
  } catch (err) {
    if (err instanceof Deno.errors.NotFound) {
      console.error(`'${cmd}' is not a ${PROGNAME} command.  See '${PROGNAME} --help'.`);
    } else {
      console.error(err.message);
    }
    Deno.exit(2);
  }
}
