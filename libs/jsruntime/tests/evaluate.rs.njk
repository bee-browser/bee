// DO NOT EDIT THIS FILE BY HAND.
//
// This file was automagically generated with:
// template: {{ template }}

// Tests contained in this file are not exhaustive.
// We'll use tc39/test262 eventually.

use assert_matches::assert_matches;
use base::macros::assert_eq;
use jsruntime::Char16Seq;
use jsruntime::Runtime;
use jsruntime::Value;
use jsruntime::U16String;

logging::init!();

#[ctor::ctor]
fn init_jsruntime() {
    jsruntime::initialize();
}

struct Validator {
    expected_values: Vec<Value>,
    actual_values: Vec<Value>,
}

impl Validator {
    fn validate(&self) {
        assert_eq!(self.actual_values.len(), self.expected_values.len());
        for (actual, expected) in self.actual_values.iter().zip(self.expected_values.iter()) {
            match expected {
                Value::Closure(_) => assert!(matches!(actual, Value::Closure(_))),
                Value::Object(_) => assert!(matches!(actual, Value::Object(_))),
                Value::Promise(_) => assert!(matches!(actual, Value::Promise(_))),
                _ => {
                    // Some cases including `f64::NAN` fail in `assert_eq!()`.
                    let actual = format!("{actual:?}");
                    let expected = format!("{expected:?}");
                    assert_eq!(actual, expected);
                }
            }
        }
    }
}

fn evaluate(src: &str, module: bool, optimize: bool, enable_labels: bool, expected_values: Vec<Value>) -> Result<Value, Value> {
    let mut runtime = Runtime::with_extension(Validator {
        expected_values,
        actual_values: vec![],
    });
    runtime.enable_scope_cleanup_checker();
    if enable_labels {
        runtime.enable_llvmir_labels();
    }
    runtime.register_host_function("print", |runtime, args| {
        let value = runtime.clone_value(&args[0]);
        runtime.extension_mut().actual_values.push(value);
    });
    let program = if module {
        runtime.parse_module(src).unwrap()
    } else {
        runtime.parse_script(src).unwrap()
    };
    let module = runtime.compile(&program, optimize).unwrap();
    runtime.link(module);
    let result = runtime.evaluate(&program)?;
    runtime.run();
    runtime.extension().validate();
    Ok(result)
}
{%- for test in data.tests %}

#[test]
fn {{ test.name }}_optimize() {
    {{ test.name }}(true, false);
}

#[test]
fn {{ test.name }}_no_optimize() {
    {{ test.name }}(false, false);
}

#[test]
fn {{ test.name }}_with_labels() {
    {{ test.name }}(false, true);
}

fn {{ test.name }}(optimize: bool, enable_labels: bool) {
    {%- for string in test.strings %}
    static CODE_UNITS{{ loop.index0 }}: [u16; {{ string.size }}] = [{{ string.data | join(", ") }}];
    static STRING{{ loop.index0 }}: Char16Seq = Char16Seq::new(&CODE_UNITS{{ loop.index0 }});
    {%- endfor %}
    let src = include_str!("{{ test.filename }}");
    let result = evaluate(src, {{ test.module }}, optimize, enable_labels, vec![
        {%- for expected in test.expectedValues %}
        {{ expected }},
        {%- endfor %}
    ]);
    {%- if test.throws %}
    assert_matches!(result, Err(actual) => {
        // Some cases including `f64::NAN` fail in `assert_eq!()`.
        let actual = format!("{actual:?}");
        let expected = format!("{:?}", {{ test.throws }});
        assert_eq!(actual, expected);
    });
    {%- else %}
    assert_matches!(result, Ok(_));
    {%- endif %}
}
{%- endfor %}
