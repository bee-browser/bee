#!/usr/bin/env node

'use strict';

const program = require('commander');
const deepmerge = require('deepmerge')
const fs = require('fs');
const yaml = require('js-yaml');

program
  .description(
    'Merge structured data stored in files like JSON and YAML')
  .option(
    '-f, --format <format>', 'Data format',
    /^(json|yaml|)$/i, 'json')
  .arguments(
    '<files...>')
  .action(async (files, options) => {
    let parse, stringify;
    switch (options.format) {
    case 'json':
      parse = JSON.parse;
      stringify = JSON.stringify;
      break;
    case 'yaml':
      parse = yaml.safeLoad;
      stringify = (s) => yaml.safeDump(s, { lineWidth: -1 /* no limit */ });
      break;
    }
    console.log(stringify(deepmerge.all(files.map((file) => parse(fs.readFileSync(file))))));
  })
  .parse(process.argv);
