// DO NOT EDIT THIS FILE BY HAND.
//
// This file was automagically generated with:
// template: {{@template}}

// Tests contained in this file are not exhaustive.
// We'll use tc39/test262 eventually.

use assert_matches::assert_matches;

use base::macros::assert_eq;
use jsgc::Handle;

use jsruntime::Runtime;
use jsruntime::StringFragment;
use jsruntime::Value;

logging::init!();

#[ctor::ctor]
fn init_jsruntime() {
    jsruntime::initialize();
}

struct Validator {
    expected_values: Vec<Value>,
    actual_values: Vec<Value>,
}

impl Validator {
    fn validate(&self) {
        assert_eq!(self.actual_values.len(), self.expected_values.len());
        for (actual, expected) in self.actual_values.iter().zip(self.expected_values.iter()) {
            match expected {
                Value::Object(_) => assert!(matches!(actual, Value::Object(_))),
                _ => {
                    // Some cases including `f64::NAN` fail in `assert_eq!()`.
                    let actual = format!("{actual}");
                    let expected = format!("{expected}");
                    assert_eq!(actual, expected);
                }
            }
        }
    }
}

fn evaluate(src: &str, module: bool, optimize: bool, enable_labels: bool, expected_values: Vec<Value>) -> Result<Value, Value> {
    let mut runtime = Runtime::with_extension(Validator {
        expected_values,
        actual_values: vec![],
    });
    runtime.enable_scope_cleanup_checker();
    if enable_labels {
        // TODO
    }
    runtime.register_host_function("print", |runtime, args| {
        let value = runtime.ensure_value_return_safe(&args[0]);
        runtime.extension_mut().actual_values.push(value);
    });
    let program_id = if module {
        runtime.parse_module(src).unwrap()
    } else {
        runtime.parse_script(src).unwrap()
    };
    let result = runtime.run(program_id, optimize)?;
    runtime.process_jobs();
    runtime.extension().validate();
    Ok(result)
}
{{#each tests}}

#[test]
fn {{name}}() {
    {{#each strings}}
    const CODE_UNITS{{@index}}: [u16; {{size}}] = [{{join data ", "}}];
    const STRING{{@index}}: StringFragment = StringFragment::new_const(&CODE_UNITS{{@index}});
    {{/each}}
    let src = include_str!("{{filename}}");
    let result = evaluate(src, {{module}}, true, false, vec![
        {{#each expectedValues}}
        {{.}},
        {{/each}}
    ]);
    {{#if throws}}
    assert_matches!(result, Err(actual) => {
        // Some cases including `f64::NAN` fail in `assert_eq!()`.
        let actual = format!("{actual:?}");
        let expected = format!("{:?}", {{throws}});
        assert_eq!(actual, expected);
    });
    {{else}}
    assert_matches!(result, Ok(_));
    {{/if}}
}
{{/each}}
