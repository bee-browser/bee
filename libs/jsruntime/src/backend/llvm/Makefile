SHELL := $(shell which bash) -eu -o pipefail -c

PROJ_DIR := $(realpath ../../../../..)
TOOLS_BIN := $(PROJ_DIR)/tools/bin

# The following files are generated by cbindgen in the build script.
CBINDGEN_FILES := bridge.hh

CODEGEN_TARGETS := \
  compiler/type_holder.cc \
  compiler/type_holder.hh \
  executor/impl.codegen.hh

.PHONY: codegen
codegen: $(CODEGEN_TARGETS)

.PHONY: clean
clean:
	@rm -f $(CBINDGEN_FILES) $(CODEGEN_TARGETS)

# Specify --Wno-error=unknown in clang-format in order to avoid errors caused by unknown options
# in //.clang-format.  clang-format used in CI jobs may be older than the local one.
%:: runtime.yaml %.njk runtime.js $(TOOLS_BIN)/nunjucks.js $(TOOLS_BIN)/update_file.js
	@echo 'Generating $(abspath $@)...'
	@deno run -q --allow-read=. runtime.js $< | \
	  deno run -q --allow-read=. $(TOOLS_BIN)/nunjucks.js $@.njk | \
	  clang-format --Wno-error=unknown | \
	  deno run -q --allow-read=. --allow-write=$@ $(TOOLS_BIN)/update_file.js $@
