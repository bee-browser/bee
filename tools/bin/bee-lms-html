#!/usr/bin/env node

'use strict';

const path = require('path');
const streamToString = require('stream-to-string');
const { URL } = require('url');
const program = require('commander');
const { run } = require('../lib/lms/html');
const { Size } = require('../lib/lms/util');

async function makeUrl(arg) {
  if (!arg) {
    const base64 = await streamToString(process.stdin, 'base64');
    return `data:text/html;base64,${base64}`
  }
  try {
    new URL(arg);
    return arg;
  } catch(e) {
    return `file://${path.resolve(arg)}`;
  }
}

program
  .description(
    'Generate layout messages from a HTML document')
  .option(
    '--debug', 'Run Chromium without the headless mode and auto-open devtools for debugging')
  .option(
    '--no-sandbox', 'Run Chromium without the sandbox')
  .option(
    '--viewport <width>x<height>', 'Viewport size',
    Size.parse, new Size(1280, 720))
  .option(
    '--json', 'Output JSON instead of JSONL')
  .option(
    '--logging', 'Enable logging')
  .arguments(
    '[url-or-path]')
  .action(async (arg, options) => await run(await makeUrl(arg), options))
  .parse(process.argv);
